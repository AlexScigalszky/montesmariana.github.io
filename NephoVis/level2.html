<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="icon" href="favicon.ico" type="image/x-icon">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="../custom.css">
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.0/css/all.css" integrity="sha384-lZN37f5QGtY3VHgisS14W3ExzMWZxybE1SJSEsQp9S+oqd12jhcu+A56Ebc1zFSJ" crossorigin="anonymous">

    <title>NephoVis Level 2</title>

    <style>
      
      body {
        background-color: white;
      }

      path.lighter {
        fill-opacity : .3;
      }

      path.lost {
        fill-opacity : 0;
      }

      .axis line {
        stroke : 'none';
      }


    </style>
  </head>
  <body>
    <div class="container">
      <div class="row">
        <h1></h1>
      </div>
      <div class="row">
        <div class="col-sm-6">
          <div class="row">
            <div class='btn-group'>
              <button type="button" class="btn shadow-sm btn-kulright dropdown-toggle" data-toggle="dropdown">Select colour</button>
              <div class="dropdown-menu" id="colour"></div>
            </div>
            <div class='btn-group'>
              <button type="button" class="btn shadow-sm btn-kulright dropdown-toggle" data-toggle="dropdown">Select shape</button>
              <div class="dropdown-menu" id="shape"></div>
            </div>
            <div class='btn-group'>
              <button type="button" class="btn shadow-sm btn-kulright dropdown-toggle" data-toggle="dropdown">Select size</button>
              <div class="dropdown-menu" id="size"></div>
            </div>
          </div>
          <div class='row'>
            <div class="btn-group btn-group-toggle" id = "selection" data-toggle="buttons">
              <label class="btn btn-danger my-1 active">
                <input type="radio" name="selection" value="click" autocomplete="off" checked> <i class="fas fa-mouse-pointer"></i> Click
              </label>
              <label class="btn btn-danger my-1">
                <input type="radio" name="selection" value="brush" autocomplete="off"> <i class='fas fa-crop-alt'></i> Select area
              </label>
            </div>
            <!-- <button type="button" class="btn shadow-sm btn-danger m-1" id="activate-brush"> Select area</button> -->
            <button type="button" class="btn shadow-sm btn-secondary m-1" id="clear-select"><i class="fas fa-eraser"></i> Clear token selection</button>
            <!-- <button type="button" class="btn shadow-sm btn-marigreen m-1" id="model-select"><i class="fas fa-arrow-alt-circle-down"></i> Confirm model selection</button> -->
          </div>
          <div class="row">
            <button type="button" class="btn shadow-sm btn-marigreen my-1" id="to-level1"><i class="fas fa-arrow-alt-circle-up"></i> UP</button>
            <div class='btn-group'>
              <button type="button" class="btn shadow-sm btn-marigreen dropdown-toggle m-1" data-toggle="dropdown"><i class="fas fa-arrow-alt-circle-down"></i> Go to model</button>
              <div class="dropdown-menu" id="models"></div>
            </div>
          </div>
        </div>
        <div class="col-sm-6" id="legendContainer">
        </div>
      </div>
      <br>
      <div class="row">
        <div class="col-sm-8" style="padding : 0px;" id="svgContainer"></div>
        <div class="col-sm-4">
          <button type="button" class="btn shadow-sm btn-secondary my-1" id="show-matrix"> Hide distance matrix </button>
          <div id="distMatrix" style="display:block;"><h3>Distance matrix</h3></div>
        </div>
      </div>
    </div>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <!-- General d3 (version 4) release -->
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <!-- d3 component to deal with arrays (in particular, for 'extent'/'min'/'max'...) -->
    <script src="https://d3js.org/d3-array.v2.min.js"></script>
    <!-- d3 component to generate axes -->
    <script src="https://d3js.org/d3-axis.v1.min.js"></script>
    <!-- d3 component to generate legends -->
    <script src="d3-legend.min.js"></script>
    <!-- d3 component for brush -->
    <script src="https://d3js.org/d3-brush.v1.min.js"></script>
    <!-- d3 component for sequential color palettes -->
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    
    <script>
      var type, modselection, tokselection;
      var ncol, nrow, width, height, padding;

      function getUrlParameter(sParam) {
        var sPageURL = decodeURIComponent(window.location.search.substring(1)),
          sURLVariables = sPageURL.split('&'),
          sParameterName,
          sParameters = [],
          i;

        for (i = 0; i < sURLVariables.length; i++) {
          sParameterName = sURLVariables[i].split('=');
          if (sParameterName[0] === sParam) {
            return sParameterName[1] === undefined ? true : sParameterName[1];
          }
          }
        };

      d3.select("#show-matrix").on("click", function() {
        if (d3.select("#distMatrix").style('display') == 'block') {
          d3.select("#distMatrix").style('display', 'none');
          d3.select(this).text('Show distance matrix');
        } else {
          d3.select("#distMatrix").style('display', 'block');
          d3.select(this).text('Hide distance matrix');
        }
        //d3.select("#buttons-selection").style('display', 'none')
      });

      type = getUrlParameter('type');
      d3.select("h1").html("Level 2 (<em>" + type + "</em>)");

      // Go back to previous level
      d3.select("#to-level1").on("click", function() {
        window.open("level1.html" + "?type=" + type, "_self")
      });

      // Make svg responsive with script from: https://brendansudol.com/writing/responsive-d3
      function responsivefy(svg) {
      // get container + svg aspect ratio
        var container = d3.select(svg.node().parentNode),
          width = parseInt(svg.style("width")),
          height = parseInt(svg.style("height")),
          aspect = width / height;

        // add viewBox and preserveAspectRatio properties,
        // and call resize so that svg resizes on inital page load
        svg.attr("viewBox", "0 0 " + width + " " + height)
          .attr("perserveAspectRatio", "xMinYMid")
          .call(resize);

        // to register multiple listeners for same event type, 
        // you need to add namespace, i.e., 'click.foo'
        // necessary if you call invoke this function for multiple svgs
        // api docs: https://github.com/mbostock/d3/wiki/Selections#on
        d3.select(window).on("resize." + container.attr("id"), resize);

        // get width of container and resize svg to fit it
        function resize() {
          var targetWidth = parseInt(container.style("width"));
          svg.attr("width", targetWidth);
          svg.attr("height", Math.round(targetWidth / aspect));
        }
      }

      // first info from LocalStorage
      modselection = JSON.parse(localStorage.getItem("modselection"));
      if (modselection == null) {
        window.alert("No models found in selection, let's go back to Level 1!");
        window.open("level1.html" + "?type=" + type, "_self");
      } else if (modselection.length > 9) {
        window.alert("You have selected too many models, only the first 9 will be used.");
        modselection = modselection.slice(0, 9);
        localStorage.setItem("modselection", JSON.stringify(modselection));
      }

      ncol = 3; // number of columns in the grid
      nrow = Math.ceil(modselection.length/ncol); // number of rows in the grid
      width = 300, height = 300, padding = 30;

      // Use the data!
      d3.tsv(type + '/' + type + ".tsv", function(data) {
        var dataset;
        var colnames, othercols, nominals, numerals;
        var colorvar, colorvalues, shapevar, shapevalues, sizevar, sizevalues;
        var colorDropdown, shapeDropdown, sizeDropdown, modDropdown;
        var tooltip;
        var svg, legendContainer, cells;
        var brush, brushCell;
        var xmin = [], ymin = [], xmax = [], ymax = []; // to scale the plots
        var xAxis, yAxis;
        var x, y, xrange, yrange, color, shape, size; // for scales
        var i, j, m; // to iterate over the models
        var legendList, legendColor, legendSize, legendShape, halign; // for legends

        // load the data
        dataset = data;
        
        // classify columns
        colnames = d3.keys(dataset[0]);
        othercols = colnames.filter(function(d) {return (!d.endsWith(".x") && !d.endsWith(".y") && !d.startsWith("_")); });

        nominals = othercols.filter(function(d) {return (!(getValues(d).every(function(d) {return(!isNaN(d)); })) && getValues(d).length <= 5); });
        nominals.push('Reset');

        numerals = othercols.filter(function(d) {return (getValues(d).every(function(d) {return(!isNaN(d)); })); });
        numerals.push('Reset');
        
        // information from localStorage
        colorvar = JSON.parse(localStorage.getItem("colorvar-" + type)) == null ? undefined : JSON.parse(localStorage.getItem("colorvar-" + type));
        colorvalues = typeof(colorvar) == 'string' ? getValues(colorvar) : +0;
        // var colorselection = JSON.parse(localStorage.getItem("colorsel")) == null ? [] : JSON.parse(localStorage.getItem("colorsel"));

        shapevar = JSON.parse(localStorage.getItem("shapevar-" + type)) == null ? undefined : JSON.parse(localStorage.getItem("shapevar-" + type));
        shapevalues = typeof(shapevar) == 'string' ? getValues(shapevar) : +0;
        // var shapeselection = JSON.parse(localStorage.getItem("shapesel")) == null ? [] : JSON.parse(localStorage.getItem("shapesel"))
        
        sizevar = JSON.parse(localStorage.getItem("sizevar-" + type)) == null ? undefined : JSON.parse(localStorage.getItem("sizevar-" + type));
        sizevalues = typeof(sizevar) == 'string' ? getValues(sizevar) : +0;
        //var sizeselection = JSON.parse(localStorage.getItem("sizesel")) == null ? [] : JSON.parse(localStorage.getItem("sizesel"))
        
        tokselection = JSON.parse(localStorage.getItem("tokselection")) == null ? [] : JSON.parse(localStorage.getItem("tokselection"));
        
        // set up dropdowns
        colorDropdown = d3.select("#colour").selectAll("button")
          .data(nominals)
          .enter()
          .append("button")
          .attr("class", "dropdown-item col")
          .attr("xlink:href", "#")
          .attr("value", function (d) { return(d); })
          .text(function (d) { return(d); });

        shapeDropdown = d3.select("#shape").selectAll("button")
          .data(nominals)
          .enter()
          .append("button")
          .attr("class", "dropdown-item shape")
          .attr("xlink:href", "#")
          .attr("value", function (d) { return(d); })
          .text(function (d) { return(d); });

        sizeDropdown = d3.select("#size").selectAll("button")
          .data(numerals)
          .enter()
          .append("button")
          .attr("class", "dropdown-item size")
          .attr("xlink:href", "#")
          .attr("value", function (d) { return(d); })
          .text(function (d) { return(d); });

        modDropdown = d3.select("#models").selectAll("button")
          .data(modselection)
          .enter()
          .append("button")
          .attr("class", "dropdown-item size")
          .attr("xlink:href", "#")
          .attr("value", function (d) { return(d); })
          .text(function (d) { return(d); });

        //add tooltip (before the svg so it is not on top of it?)
        tooltip = d3.select("body").append('div')
          .attr("class", "tooltip")
          .attr("width", 100)
          .attr("height", 20)
          .style('position', 'absolute')
          .style("opacity", 0);

        // Set up legend area next to it (horizontal and before plots)
        legendContainer = d3.select("#legendContainer").append("svg")
          .attr("width", 500)
          //.attr("height", 100)
          .attr("transform", "translate(0, 0)");
        
        // Set up canvas
        svg = d3.select("#svgContainer").append("svg")
          .attr("width", width*ncol)
          .attr("height", height*nrow + padding*2)
          .call(responsivefy)
          //.style("background-color", "lightgray")
          .attr("transform", "translate(0,0)")
          .append("g");
        
        // Set up brush
        brush = d3.brush()
          .extent([[0,0],[width, height]])
          .on('start', brushstart)
          .on('brush', brushing)
          .on('end', brushed);

        function brushstart(p) {
          if(!(brushCell == this)){
          if(!(brushCell == undefined)) {d3.selectAll('.brush').call(brush.move, null); }
          tokselection = [];
          updateTokSelection(tokselection);
          brushCell = this;
          }
        }

        function brushing(p) {
          var e = d3.event.selection;
          if (!(e == null)){
          svg.selectAll('.dot').selectAll('path')
            .classed('lighter', function(d) {
              var xc = x(d[p.m + '.x']);
              var yc = y(d[p.m + '.y']);
              return (xc < e[0][0]+padding || xc > e[1][0]+padding || yc < e[0][1]+padding || yc > e[1][1]+padding);
            }); }
        }

        function brushed(p) {
          tokselection = [];
          svg.selectAll('.dot').selectAll('path')
            .each(function(d) {
              if(!(d3.select(this).classed("lighter")) && tokselection.indexOf(d['_id']) === -1) {
                tokselection.push(d['_id']);
              }
            });
          updateTokSelection(tokselection);
        }
    
        // Set up scales (axes, color...) - coordinates multiplied to get some padding in a way
        modselection.forEach(function(item) {
          xmin.push(d3.min(dataset, function(d) {return (+d[item + ".x"]); }));
          ymin.push(d3.min(dataset, function(d) {return (+d[item + ".y"]); }));
          xmax.push(d3.max(dataset, function(d) {return (+d[item + ".x"]);}));
          ymax.push(d3.max(dataset, function(d) {return (+d[item + ".y"]);}));
          });
        
        xrange = [d3.min(xmin) * 1.05, d3.max(xmax) * 1.05];
        yrange = [d3.min(ymin) * 1.05, d3.max(ymax) * 1.05];
        
        x = d3.scaleLinear()
          .domain(xrange)
          .range([padding, width]);

        y = d3.scaleLinear()
          .domain(yrange)
          .range([height, padding]);

        color = d3.scaleOrdinal(d3.schemeCategory10);

        shape = d3.scaleOrdinal(d3.symbols);

        size = d3.scaleLinear()
          .range([40, 200]); // remember to set the domain (current variable) before assigning a value

        // Vertical center
        xAxis = d3.axisBottom(x).tickSizeOuter(0);
        yAxis = d3.axisLeft(y).tickSizeOuter(0);

        function combine(modselection) {
          var c = [];
          for (m = 0, i = 0, j = 0; m < modselection.length; m ++) {
            c.push({m : modselection[m], i : i, j : j});
            if (i == ncol-1) {
            i = 0;
            j += 1;
          } else {
            i += 1;
          }
          }
          return(c);
        }

        function exists(t, c) {
          var thisModel = c.attr('model');
          return (d3.format('.3r')(t[thisModel + '.x']) != '0.00' || d3.format('.3r')(t[thisModel + '.y']) != '0.00');
        }

        cells = svg.selectAll(".cell")
          .data(combine(modselection))
          .enter()
          .append('g')
          .attr('class', 'cell')
          .attr('transform', function(d) {
            return('translate(' + (+d.i)*width + ", " + +((height+padding/2)*(+d.j)) + ")");
          })
          .attr('model', function(d) {return(d.m)})
          .each(plotCell);

        $(document).on('change', 'input[name="selection"]', function(event) {
          var radio = d3.select(this).attr('value');
          if(radio == 'brush') {
              cells.append('g')
                .attr("transform", "translate(" + padding + ", " + padding + ")")
                .attr("class", "brush")
                .call(brush);
            } else {
              svg.selectAll(".brush").remove();
            }
          tokselection = [];
          updateTokSelection(tokselection);
        })

        function plotCell(p) {
          var cell = d3.select(this);
          
          cell.append('text')
            .attr('x', padding*1.5)
            .attr('y', padding)
            .attr('dy', '-0.5em')
            .attr('font-size', '0.7em')
            .style('cursor', 'pointer')
            .text(function(d) { 
              return (d.m.length > 45 ? d.m.substring(0, 43) + '...' : d.m); })
            .on("click", function(d) {
              window.open("level3.html" + "?type=" + type + "&model=" + d.m, "_self");
            })
            .on('mouseover', function(d) {
              tooltip.transition()
                .duration(200)
                .style("opacity", 1)
                .style("background-color", "white")
                .style("border", "solid")
                .style("border-color", "lightgray");
              tooltip.html(d.m)
                .style("left", (d3.event.pageX + 3) + "px")
                .style("top", (d3.event.pageY -3 ) + "px");
            })
            .on('mouseout', function() {
              tooltip.transition()
                .duration(200)
                .style("opacity", 0);
              d3.selectAll(".selector").remove();
            });

          // Draw frame
          cell.append('rect')
            .attr('x', padding)
            .attr('y', padding)
            .attr('width', width-padding)
            .attr('height', height-padding)
            .style('fill',  'none')
            .style('stroke', 'black')
            .style("pointer-events", "all")
            .style('stroke-width', 0.5);

          cell.append('line')
            .attr("class", "xCenter")
            .attr("x1", x(0))
            .attr("y1", padding)
            .attr("x2", x(0))
            .attr("y2", height)
            .attr("stroke", "lightgray")
            .attr("stroke-width", 1);

          cell.append('line')
            .attr("class", "yCenter")
            .attr("y1", y(0))
            .attr("x1", padding)
            .attr("y2", y(0))
            .attr("x2", width)
            .attr("stroke", "lightgray")
            .attr("stroke-width", 1);

          cell.append("g")
            .attr("class", "axis xAxis")
            .attr("transform", "translate(0, " + height + ")")
            .call(xAxis);

          cell.append("g")
            .attr("class", "axis yAxis")
            .attr("transform", "translate(" + padding + ", " + 0 +")")
            .call(yAxis);

          var circle = cell.append('circle')
            .attr('cx', padding)
            .attr('cy', padding)
            .attr('r', padding/2)
            .style('fill', color(0));

          cell.append('text')
            .attr('x', padding)
            .attr('y', padding)
            .attr('dx', '-0.3em')
            .attr('dy', '0.3em')
            .text(function(d) {return (modselection.indexOf(d.m)+1); })
            .style('fill', 'white')
            .style('font-weight', 'bold');

          cell.append("g")
            .attr("transform", "translate(0,0)")
            .attr("class", "dot")
            .selectAll("path")
            .data(dataset)
            .enter()
            .append('path')
            .attr("transform", function(d) {
              return ("translate(" + x(d[cell.attr('model') + '.x']) + "," + y(d[cell.attr('model') + '.y']) + ")"); })
            .attr("d", d3.symbol()
              .type(function (d) {return (typeof(shapevar) == 'string' ? shape(d[shapevar]) : d3.symbolCircle); })
              .size(function(d) {
                if (typeof(sizevar) == 'string') {
                  size.domain(d3.extent(dataset, function(d) {return (+d[sizevar]); }));
                  return(size(+d[sizevar]));
                } else {
                  return(50);
                }}))
            .style('fill', function(d) {return (typeof(colorvar) == 'string' ? color(d[colorvar]) : "#1f77b4"); })
            .style('opacity', 0.7)
            .attr('model', modselection[m])
            //.attr('token_id', function(d) {return(d['_id'])})
            .classed("lighter", function(d) {
              return (tokselection.length > 0 ? (tokselection.indexOf(d['_id']) === -1 && exists(d, cell)) : false);
              })
            .classed("lost", function(d) {return(!exists(d, cell)); })
            .on('mouseover', function(d) {
              var thisModel = cell.attr('model');
              var xcoord = "<b>x:</b> " + d3.format('.3r')(d[thisModel + '.x']);
              var ycoord = "<b>y:</b> " + d3.format('.3r')(d[thisModel + '.y']);
              tooltip.transition()
                .duration(200)
                .style("opacity", 1)
                .style("background-color", "white")
                .style("border", "solid")
                .style("border-color", "lightgray");
              tooltip.html("<b>" + d['_id'] + "</b><br>" + xcoord + ", " +  ycoord)
                .style("left", (d3.event.pageX + 3) + "px")
                .style("top", (d3.event.pageY - 50) + "px");
            })
            .on('mouseout', function() {
              tooltip.transition()
                .duration(200)
                .style("opacity", 0);
              d3.selectAll(".selector").remove();
            })
            .on('click', function(d) {
              var tokId = d['_id'];
              var tokIndex = tokselection.indexOf(tokId);
              if (tokIndex > -1) {
                tokselection.splice(tokIndex, 1);
              } else {
                tokselection.push(tokId);
              }
              updateTokSelection(tokselection);
            }); 
        }
        
        // what happens when we click on the dropdowns?
        colorDropdown.on("click", function() {
          this.value == 'Reset' ? colorvar = null : colorvar = this.value;
          localStorage.setItem("colorvar-" + type, JSON.stringify(colorvar));
          updatePlot();
          updateLegend();
        });

        shapeDropdown.on("click", function() {
          this.value == 'Reset' ? shapevar = null : shapevar = this.value;
          localStorage.setItem("shapevar-" + type, JSON.stringify(shapevar));
          updatePlot();
          updateLegend();
        });

        sizeDropdown.on("click", function() {
          this.value == 'Reset' ? sizevar = null : sizevar = this.value;
          if (typeof(sizevar) == 'string') {
            size.domain(d3.extent(dataset, function(d) {return (+d[sizevar]); }));
          }
          localStorage.setItem("sizevar-" + type, JSON.stringify(sizevar));
          updatePlot();
          updateLegend();
        });

        modDropdown.on("click", function() {
          window.open("level3.html" + '?type=' + type + '&model=' + this.value, "_self");
        });

        // clear selection of models
        d3.select("#clear-select")
          .on("click", function() {
            tokselection = [];
            updateTokSelection(tokselection);
          });

        // Updating color, shape and size after every button clicking
        function updatePlot() {
          svg.selectAll('.dot').selectAll('path')
            .style("fill", function(d) {return (typeof(colorvar) == 'string' ? color(d[colorvar]) : "#1f77b4"); })
            .attr("d", d3.symbol().type(function(d) {
              return (typeof(shapevar) == 'string' ? shape(d[shapevar]) : d3.symbolCircle);
              }).size(function(d) {
                return (typeof(sizevar) == 'string' ? size(+d[sizevar]) : 50); }));
        }

        // Generate complementary colors for the circle on hover
        function compColor(col) {
          res = d3.hsl(col);
          hue = res['h'];
          newHue = +hue < 180 ? +(hue + 180) : +(hue-180);
          res['h'] = newHue;
          return(res.toString());
        }

        // Short function to obtain the possible values of a variable
        function getValues(colname) {
          return(d3.map(dataset, function(d) {return d[colname]}).keys());
        }

        function cleanStor(item) {
          localStorage.setItem(item, JSON.stringify(null))
        }

        // update token selection
        function updateTokSelection(tokselection) {
          // stores 'null' if it's empty and the list otherwise
          localStorage.setItem("tokselection", tokselection.length > 0 ? JSON.stringify(tokselection) : JSON.stringify(null));
          // if something is selected everything else is translucent
          svg.selectAll(".dot").selectAll("path")
            .classed("lighter", function(d) {return (tokselection.length > 0 ? tokselection.indexOf(d['_id']) === -1 : false); });
        }

        // Update Legends after each dropdown is changed

        function updateLegend() {
          legendList = [];
          legendContainer.selectAll(".legend").remove();
          colorvalues = typeof(colorvar) == 'string' ? getValues(colorvar) : +0;
          shapevalues = typeof(shapevar) == 'string' ? getValues(shapevar) : +0;
          sizevalues = typeof(sizevar) == 'string' ? getValues(sizevar) : +0;

          // Update color legend
          if (typeof(colorvalues) != 'number'){
            colorvalues.sort();

            var colorscale = d3.scaleOrdinal()
              .domain(colorvalues)
              .range(colorvalues.map(color));
            
            legendColor = d3.legendColor()
              .shape("path", d3.symbol().type(d3.symbolCircle).size(50)())
              .scale(colorscale)
              .title(colorvar);
         
            legendContainer.append("g")
              .attr("class", "legend")
              .attr("id", "legendColor")
              .attr("transform", "translate(" + 0 + ", " + padding/2 + ")")
              .call(legendColor);

            legendList.push('color');
            
              } else {
                if(legendList.indexOf('color') > -1) {legendList.splice(indexOf('color'), 1); }
                legendContainer.select("#legendColor").remove();
              }
          
          // Update shape legend
          if (typeof(shapevalues) != 'number'){
            var shapescale = d3.scaleOrdinal()
              .domain(shapevalues)
              .range(shapevalues.map(function(d) {
                return(d3.symbol().type(shape(d))());
              }));
            
            legendShape = d3.legendSymbol()
              .scale(shapescale)
              .title(shapevar);

            halign = legendList.indexOf('color') == -1 ? 0 : 150;
            
            legendContainer.append("g")
              .attr("class", "legend")
              .attr("id", "legendShape")
              .attr("transform", "translate(" + halign + ", " + padding/2 + ")")
              .call(legendShape);

            legendList.push('shape');
            
              } else {
                if(legendList.indexOf('shape') > -1) {legendList.splice(legendList.indexOf('shape'), 1); }
                legendContainer.select("#legendShape").remove();
              }

          // Update size legend
          if (typeof(sizevalues) != 'number'){
            var sizescale = d3.scaleLinear()
              .domain(d3.extent(dataset, function(d) {return +d[sizevar];}))
              .range([5, 8]);
            sizevalues = sizevalues.map(function(d) {return +d;}).sort();
            var smallNumbers = (sizescale.domain()[1]-sizescale.domain()[0])/(sizevalues.length-1) < 1;
            
            legendSize = d3.legendSize()
              .shape('circle')
              .scale(sizescale)
              .title(sizevar)
              .cells(sizevalues.length >= 5 ? 5 : sizevalues.length)
              .labelFormat(smallNumbers ? ".04r" : ".0d");           
              // no selection through size

            halign = 150*legendList.length;
            
            legendContainer.append("g")
              .attr("class", "legend")
              .attr("id", "legendShape")
              .attr("transform", "translate(" + halign + ", " + padding/2 + ")")
              .call(legendSize);

            legendList.push('size');
            
              } else {
                if(legendList.indexOf('size') > -1) {legendList.splice(legendList.indexOf('size'), 1); }
                legendContainer.select("#legendSize").remove();
              }
        }

        updateLegend();
        updateTokSelection(tokselection);
       });

      d3.tsv(type + "/" + type + ".models.dist.tsv", function(error, data) {
        if (error && error.target.status === 404) {
          d3.select("#distMatrix").text("Distance matrix not available.");
          throw error;
        }

        var distances, distMatrix, distCols, distRows, rows;
        var miniWidth, miniHeight, color;
        var distWidth = 200,
          distHeight = 200,
          distPad = 10;

        distances = data.filter(function(d) {return (modselection.indexOf(d['_model']) > -1); });

        distMatrix = d3.select("#distMatrix").append("svg")
          .attr("width", distWidth)
          .attr("height", distHeight)
          .attr("padding", distPad)
          .call(responsivefy)
          .attr("transform", "translate(0,0)");

        miniWidth = (distWidth-3*distPad)/distances.length;
        miniHeight = (distHeight-3*distPad)/distances.length;

        distCols = distMatrix.append('g')

        distCols.selectAll('text')
          .data(modselection).enter()
          .append('text')
          .attr('x', function(d) {return (distPad + miniWidth*(modselection.indexOf(d)+0.5)); })
          .attr('y', distPad*0.7)
          .style('font-size', '0.6em')
          .text(function(d) {return (modselection.indexOf(d)+1); });

        distRows = distMatrix.append('g')

        distRows.selectAll('text')
          .data(modselection).enter()
          .append('text')
          .attr('x', 0)
          .attr('y', function(d) {return (distPad + miniHeight *(modselection.indexOf(d)+0.5)); })
          .style('font-size', '0.6em')
          .text(function(d) {return (modselection.indexOf(d)+1); });

        color = d3.scaleSequential(d3.interpolateGreens)

        rows = distMatrix.append("g")
          .selectAll(".distrowrow")
          .data(distances)
          .enter()
          .append("g")
            .attr('class', 'distrow')
            .attr('transform', function(d) {
              return('translate(' + 10 + ',' + (10 + miniHeight * modselection.indexOf(d['_model'])) + ')'); })
            .each(fillRow);

        function fillRow(p) {
          var row = d3.select(this);
          var rowData = [];
          modselection.forEach(function(d) {
            rowData.push({'model' : d, 'value' : p[d]})
          });

          row.selectAll("rect")
            .data(rowData)
            .enter()
            .append('rect')
            .attr('width', miniWidth)
            .attr('height', miniHeight)
            .attr('transform', function(d) {
              return ('translate(' + miniWidth * (modselection.indexOf(d.model)) + ', 0)'); 
            })
            .style('fill', function(d) {return (color(d.value)); });

          row.selectAll('text')
            .data(rowData).enter()
            .append('text')
            .attr('x', function(d) {return (miniWidth * (modselection.indexOf(d.model)+0.3)); })
            .attr('y', miniHeight/2)
            .attr('dy', (1/modselection.length) + 'em')
            .attr('dx', '-' + (1/modselection.length) + 'em')
            .text(function(d) {return (d3.format('.2f')(d.value)); })
            .style('font-size', (1/modselection.length)*3  + 'em')
            .style('fill', function(d) {
              var light = d3.hsl(color(d.value))['l'];
              return(light <= 0.5 ? 'white' : 'black');
            })
            .style('font-weight', 'bold');
        }
      });
      
    </script>
  </body>
</html>