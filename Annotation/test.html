<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

    <title>Downloadtest</title>

    <style>
    
    #download {
        color : white;
    }

    .btn-cue {
        color : black;
        background : white;
        border-color : none;
    }

    .btn-cue:hover, .btn-cue:active, .btn-cue.active {
        color: white;
        background: #1f77b4;
        border-color: #1f77b4;
    }

    .btn-cue:active, .btn-cue.active {
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.15), 0 1px 1px rgba(0, 0, 0, 0.075), 0 0 0 0.2rem rgba(0, 123, 255, 0.5);
    }

    </style>
  </head>
  <body>
    <div class="container">
        <h1>Disambiguating churches</h1>
        <div class="row">
            <div class="col-sm-6">
                <p>Please type your username (firstname.lastname), like in your student e-mail.</p>
                <div class="input-group mb-3 ui-widget">
                    <div>
                    <input type="text" class="form-control" id='username' placeholder="mariana.montes" aria-label="username" aria-describedby="input username">
                    </div>
                    <div class="input-group-append">
                        <button class="btn btn-danger" type="button" id='submitName'>That's me</button>
                    </div>
                </div>
                <p>If you've already started, you may upload the file with your progress.</p>
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text" id="uploadfile">Upload</span>
                    </div>
                    <div class="custom-file">
                        <input type="file" class="custom-file-input" id="filename" aria-describedby="inputGroupFileAddon01">
                        <label class="custom-file-label" for="filename" id="filelabel">Choose file</label>
                    </div>
                </div>
            </div>
            <div class="col-sm-6" id="sense_codes" style="text-align:right;">
                <h3>Sense tags</h3>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-12" id="concordance"></div>
        </div>
        <div class="row">
            <div class="col">
                <button type="button" class="btn shadow-sm btn-primary m-1"><a id="download">Download progress</a></button>
            </div>
        </div>
    </div>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <!-- <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script> -->
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <!-- General d3 (version 4) release -->
    <script src="https://d3js.org/d3.v4.min.js"></script>

    <script>
        var dropdown,
            text = {}, users,
            type = 'church',
            definitions = {};

        d3.select("#uploadfile").on("click", function() {
            var reader = new FileReader();
            var file = d3.select("#filename").property('files')[0];
            reader.onload = function(e) {text = reader.result; }
            reader.readAsText(file);
            console.log("clicked");
            // console.log(reader.result);
        });

        d3.select("#filename").on("change", function() {
            d3.select("#filelabel").text(d3.select(this).property('files')[0]['name']);
        });

        d3.select("#download").on("click", function() {
            var file = JSON.stringify(text);
            console.log(file);
            d3.select(this).attr("href", 'data:text/plain;charset=utf-8,' + encodeURIComponent(file))
                .attr("download", text['user'] + ".json");
        });

        d3.json("users.json", function(data) {
            users = data;

            $( function() {
                var names = d3.map(users, function(d) {return(d.name); }).keys();
            $("#username").autocomplete({source: names});
        });
        });

        definitions['church'] = [
                {name : 'service', label : "I go to church."},
                {name : 'building', label : "There is a pretty altar in the church."},
                {name : 'congregation', label : "My aunt belongs to that church."},
                {name : 'organization', label : "The church condemns eating chocolate."}
            ]

        d3.tsv(type + ".tsv", function(data) {
            var dataset, sense_options, conc,
                concordances = [],
                toClassify = 0;

            d3.select("#submitName").on('click', function() {
                text['user'] = d3.select("#username").property("value");
                var names = d3.map(users, function(d) {return(d.name); }).keys();
                if (names.indexOf(text['user']) == -1) {
                    window.alert("I don't know you, get out");
                    } else {
                        start();
                    }
                // text.push({'user' : lastname + '_' + firstname})
                });

            concordances = data.slice(0, 10);
            
            sense_options = definitions[type];

            d3.select("#sense_codes").selectAll("p")
                .data(sense_options)
                .enter()
                .append("p")
                .html(function(d) {
                    return("<b>" + d.name + "</b> ('" + d.label + "')")
                });

            function start(){
                var workspace, tabs, conc, buttons, conf, annotations, reminder;

                workspace = d3.select("#concordance");

                workspace.append("h2").text("Let's disambiguate!");

                tabs = workspace.append("ul")
                    .attr("class", "nav nav-tabs")
                    .attr("role", "tablist");
                    
                tabs.selectAll("li")
                    .data(["overview", "senses", "cues"]).enter()
                    .append("li")
                    .attr("class", "nav-item")
                    .append("a")
                        .attr("class", "nav-link")
                        .attr("id", function(d) {return(d + "-tab"); })
                        .attr("data-toggle", "tab")
                        .attr("href", function(d) {return("#" + d); })
                        .attr("role", "tab")
                        .attr("aria-controls", function(d) {return(d); })
                        .text(function(d) {return(d.toUpperCase()); });

                workspace.append("div").attr("class", "tab-content")
                    .selectAll("div")
                    .data(["overview", "senses", "cues"]).enter()
                    .append("div")
                        .attr("class", "tab-pane")
                        .attr("id", function(d) {return(d); })
                        .attr("width", "100vp")
                        .attr("role", "tabpanel")
                        .attr("aria-labelledby", function(d) {return(d + "-tab"); });

                d3.select("#overview")
                    .classed("active", true)
                    .selectAll("div")
                    .data(concordances).enter()
                        .append("div").attr("class", "row no-gutters")
                        .each(concordancer);

                conc = d3.select("#senses").append("div").attr("class", "row mt-5")
                    .append("div").attr("class", "col-sm-12").selectAll("div")
                    .data(concordances).enter()
                        .append("div");

                conc.style('display', function(d) {
                        return(concordances.indexOf(d) == toClassify ? 'block' : 'none');
                        })
                    .append("div").attr("class", "row no-gutters").each(concordancer);

                annotations = conc.append("div").attr("class", "row");

                annotations.append("div").attr("class", "col-sm-6")
                    .append("div").attr("class", "btn-group-toggle mt-2")
                    .attr("data-toggle", "buttons")
                    .selectAll("label")
                    .data(sense_options)
                        .enter()
                        .append("label")
                        .attr("class", "btn shadow-sm btn-success m-1")
                        .text(function(d) {return(d.name); })
                        .append("input")
                        .attr("type", "radio")
                        .attr("autocomplete", "off")
                        .attr("name", "sense")
                        .attr("value", function(d) {return(d.name)});

                conf = annotations.append("div").attr("id", "confidence")
                    .attr("class", "col-sm-6 mt-2")
                    .append("h4").text("How confident are you?")
                    .append("div")
                    .attr("class", "btn-group-toggle mt-2")
                    .attr("data-toggle", "buttons");

                conf.append("span")
                    .style('font-size', '0.7em')
                    .style('font-weight', 'bold')
                    .text("Not at all ");

                conf.selectAll("label")
                    .data([0, 1, 2, 3, 4, 5]).enter()
                        .append("label")
                        .attr("class", "btn shadow-sm btn-warning")
                        .text(function(d) {return(d); })
                        .append("input").attr("type", "radio")
                        .attr("autocomplete", "off").attr("name", "confidence")
                        .attr("value", function(d) {return (d); });

                conf.append("span")
                    .style('font-size', '0.7em')
                    .style('font-weight', 'bold')
                    .text(' Completely');

                conc.append("br");

                conc.append("p").text("Any observations about this concordance?")
                conc.append("div").append("input")
                    .attr("class", "form-control")
                    .attr("id", function(d) {return(d.id + "_comment"); })
                    .attr("name", "comments")
                    .attr("placeholder", "No comments")
                    .attr("aria-label", "Comments");
                
                addButtons('senses');

                cues = d3.select("#cues")
                    .append("div").attr("class", "row")
                    .append("div").attr("class", "col-sm-12")
                    .selectAll("div")
                        .data(concordances).enter()
                        .append("div")
                        .style('display', function(d) {
                        return(concordances.indexOf(d) == toClassify ? 'block' : 'none');
                        });
                
                reminder = cues.append("div").attr("class", "row")
                    .append("p")
                    .html(function(d) {
                        var this_token = text[d.id];
                        if (this_token == undefined) {
                            return("You haven't annotated this occurrence yet.");
                        } else {
                            return("You have assigned the sense <b>" + this_token['sense'] + "</b> to this occurrence.");
                        }
                    });                    
                
                cues.append("div").attr("class", "row")
                    .each(function(d) {
                        var line = d3.select(this),
                            left_context = [], right_context = [],
                            left_source = d.left.split(' '),
                            right_source = d.right.split(' ');
                        
                        for (i = 0; i < left_source.length; i++) {
                            var cw_idx = left_source.length-i-1;
                            left_context.push({'index' : 'L'+cw_idx.toString(), 'cw' : left_source[i]});
                        }

                        for (i = 0; i < right_source.length; i++) {
                            right_context.push({'index' : 'R'+(i).toString(), 'cw' : right_source[i]});
                        }

                        line.append("div").attr("class", "col-sm-auto")
                            .append("div").attr("class", "btn-group-toggle")
                            .attr("data-toggle", "buttons")
                            .attr("disabled", true)
                            .selectAll("label")
                            .data(left_context).enter()
                                .append("label").attr("class", "btn btn-cue p-0")
                                .text(function(d) {return(d.cw); })
                                .append("input").attr("type", "checkbox")
                                .attr("autocomplete", "off")
                                .attr("value", function(d) {return (d.index); });

                        line.append("div").attr("class", "col-sm-auto px-0")
                            .append("p").attr("class", "text-sm-center")
                            .style("font-weight", "bold")
                            .style("color", "#1f77b4")
                            .text(function(d) {return (d.target); });

                        line.append("div").attr("class", "col-sm-auto")
                            .append("div").attr("class", "btn-group-toggle")
                            .attr("data-toggle", "buttons")
                            .attr("disabled", true)
                            .selectAll("label")
                            .data(right_context).enter()
                                .append("label").attr("class", "btn btn-cue p-0")
                                .text(function(d) {return(d.cw); })
                                .append("input").attr("type", "checkbox")
                                .attr("autocomplete", "off")
                                .attr("value", function(d) {return (d.index); });

                    });

                    $("#cues").on("change", "input[type='checkbox']", function(event){
                        var analized = concordances[toClassify]['id'];
                        var answer = d3.select(this).attr('value');
                        
                        var cues_list = text[analized]['cues'];
                        if (cues_list.indexOf(answer) === -1) {
                            cues_list.push(answer);
                        } else { //if you are unclicking
                            cues_list.splice(cues_list.indexOf(answer), 1);
                        }
                        console.log(text[analized]);
                    });

                addButtons('cues');

                function concordancer(c) {
                    var line = d3.select(this);
                    
                    line.append("div").attr("class", "col-sm-6")
                        .append("p").attr("class", "text-sm-right")
                        .text(function(d) {return (d.left); });
                    
                    line.append("div").attr("class", "col-sm-1 px-0")
                        .append("p").attr("class", "text-sm-center")
                        .style("font-weight", "bold")
                        .style("color", "#1f77b4")
                        .text(function(d) {return (d.target); });

                    line.append("div").attr("class", "col-sm-5")
                        .append("p").attr("class", "text-sm-left")
                        .text(function(d) {return (d.right); });
                }

                function addButtons(tab) {
                    var t = tab == 'senses' ? conc : cues;

                    buttons = d3.select("#" + tab).append("div")
                        .attr("class", "btn-group mt-2");
                    
                    buttons.append("button")
                        .attr("type", "button")
                        .attr("class", "btn shadow-sm btn-secondary")
                        .text("Previous")
                        .on("click", function() {
                            toClassify > 0 ? toClassify -= 1 : toClassify = 0;
                            t.style('display', function(d) {
                                return(concordances.indexOf(d) == toClassify ? 'block' : 'none');
                            });
                        });

                    buttons.append("button")
                        .attr("type", "button")
                        .attr("class", "btn shadow-sm btn-secondary")
                        .text("Next")
                        .on("click", function() {
                            toClassify < concordances.length ? toClassify += 1 : toClassify = toClassify;
                            t.style('display', function(d) {
                                return(concordances.indexOf(d) == toClassify ? 'block' : 'none');
                            });
                        });
                }

                $(document).on('change', 'input[name="sense"]', function(event) {
                    var analized = concordances[toClassify]['id'];
                    var answer = d3.select(this).attr('value');
                    text[analized] = {};
                    text[analized]['sense'] = answer;
                    text[analized]['cues'] = [];
                    cues.selectAll('.btn-group-toggle').attr('disabled', null);
                    reminder.html(function(d) {
                        var this_token = text[d.id];
                        if (this_token == undefined) {
                            return("You haven't annotated this occurrence yet.");
                        } else {
                            return("You have assigned the sense <b>" + this_token['sense'] + "</b> to this occurrence.");
                        }
                    });
                });

                $(document).on('change', 'input[name="confidence"]', function(event) {
                    var analized = concordances[toClassify]['id'];
                    var answer = d3.select(this).property('value');
                    if (text[analized] == undefined) {
                        window.alert("You have to assign a sense first!");
                        d3.select(this).property('checked', false);
                        // HOW TO REALLY UNCHECK IT???
                    } else {
                        text[analized]['confidence'] = answer;
                    }
                    console.log(text);
                });

                $(document).on('change', 'input[name="comments"]', function(event) {
                    var analized = concordances[toClassify]['id'];
                    var answer = d3.select(this).property('value');
                    if (text[analized] == undefined) {
                        window.alert("You have to assign a sense first!");
                    } else {
                        text[analized]['comments'] = answer;
                    }
                    console.log(text);
                });
            }

        });
    </script>
  </body>
</html>