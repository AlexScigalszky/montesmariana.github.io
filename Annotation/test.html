<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="icon" href="favicon.ico" type="image/x-icon">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

    <title>Sense annotation</title>

    <style>
    
    #download {
        color : white;
    }

    .btn-cue {
        color : black;
        background : white;
        border-color : none;
    }

    .btn-cue:hover, .btn-cue:active, .btn-cue.active {
        color: white;
        background: #1f77b4;
        border-color: #1f77b4;
    }

    .btn-cue:active, .btn-cue.active {
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.15), 0 1px 1px rgba(0, 0, 0, 0.075), 0 0 0 0.2rem rgba(0, 123, 255, 0.5);
    }

    </style>
  </head>
  <body>
    <div class="container">
        <div class="row justify-content-sm-center">
            <h1>Senses annotation</h1>
        </div>
        <div class="row justify-content-sm-center">
            <div class="col-sm-6" id="left-column">
                <button type="button" class="btn shadow-sm btn-primary m-1"><a id="uploadfile">Upload progress</a></button>
                <div id="type_selection"></div>
            </div>
            <div class="col-sm-6" id="right-column" style="text-align:right;">
            </div>
        </div>
        <div class="row justify-content-sm-center" id="concordance-row">
        </div>
        <div class="row justify-content-sm-center">
            <div class="col">
                <button type="button" class="btn shadow-sm btn-primary m-1"><a id="download">Download progress</a></button>
            </div>
        </div>
    </div>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <!-- <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script> -->
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <!-- General d3 (version 4) release -->
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <!-- Sweet alert (for nice alerts) -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@8"></script>

    <script>
        var dropdown,
            text = {}, saved = JSON.stringify(text),
            users, this_user, names,
            definitions = {};

        d3.select("#uploadfile").on("click", function(){
            Swal.fire({
                title: 'Select your file',
                input: 'file',
                inputAttributes: {
                    accept: '*.json'
                }
            }).then((file) => {
                if (file.value){
                var reader = new FileReader();
                reader.onload = (e) => {
                    uploaded_text = JSON.parse(reader.result);
                    if (uploaded_text['user'] == text['user']){
                        text = uploaded_text;
                        saved = JSON.stringify(text);
                        localStorage.setItem("annotations-" + text['user'], saved);
                        Swal.fire({
                            title: "File uploaded",
                            type: "success"
                        });
                    } else {
                        Swal.fire({
                            title: "Wrong file",
                            text: "Username doesn't match",
                            type: "error"
                        });
                    }
                    
                }
                reader.readAsText(file.value);
            }
            });
            console.log(text);
        });

        d3.select("#download").on("click", function() {
            saved = JSON.stringify(text);
            localStorage.setItem("annotations-" + text['user'], saved);
            console.log(text);
            d3.select(this).attr("href", 'data:text/plain;charset=utf-8,' + encodeURIComponent(saved))
                .attr("download", text['user'] + ".json");
        });

        d3.json("definitions.json", function(data) {
            definitions = data;
        });
        
        d3.json("users.json", function(data) {
            users = data;
            names = d3.map(users, function(d) {return(d.name); }).keys();
            Swal.fire({
                title: "Welcome!",
                text: "Please enter your username",
                input: "text",
                inputPlaceholder: "mariana.montes",
                showCancelButton: true,
                inputValidator: (value) => {
                    if (names.indexOf(value) == -1) {
                        return "Invalid username, please try again."
                    }
                }
            }).then((result) => {
                if (result.value) {
                    Swal.fire({
                        title: "Login succesful!",
                        type: "success",
                        confirmButtonText: "Let's start!"
                    });
                    this_user = result.value;
                    text['user'] = result.value;
                    if (JSON.parse(localStorage.getItem("annotations-" + text['user'])) != null) {
                        text = JSON.parse(localStorage.getItem("annotations-" + text['user']));
                        }
                    saved = JSON.stringify(text);
                    this_user = users.filter(function(d) {return(d.name == text['user'])})[0];
                    offerTypes(this_user);
                }
            });
        });

        window.onbeforeunload = function(){
            if (saved != JSON.stringify(text)) {
                return("No please No!!");
            } else {
                return;
            }
        };
            
        function offerTypes(this_user) {
            var this_types = d3.keys(this_user['tokens']),
                typesel;
            
            typesel = d3.select("#left-column").append("div").attr("id", "type_selection");
            typesel.append("h3").text("Select a type, please");
            typesel.append("div").attr("class", "btn-group-toggle mt-2")
                .attr("data-toggle", "buttons")
                .selectAll("label")
                .data(this_types)
                    .enter()
                    .append("label")
                    .attr("class", "btn shadow-sm btn-success m-1")
                    .text(function(d) {return(d); })
                    .append("input")
                    .attr("type", "radio")
                    .attr("autocomplete", "off")
                    .attr("name", "type")
                    .attr("value", function(d) {return(d)});

            $(document).on("change", "input[name='type']", function(event) {
                type = d3.select(this).property('value'); 
                start();
            });
        }

        function start() {
            
            $("#concordance").remove();
            $("#sense_codes").remove();

            d3.select("#concordance-row").append("div")
                .attr("class", "col-sm-12")
                .attr("id", "concordance");

            d3.select("#right-column").append("div").attr("id", "sense_codes")

            d3.tsv(type + ".tsv", function(data) {
            var concordances = [],
                toClassify = this_user['tokens'][type], viewing = 0,
                workspace, tabs,
                sense_options, conc, annotations, inputtext,
                conf, cues, reminder,
                buttons;

            concordances = data.filter(function(d) {return(toClassify.indexOf(d.id)>-1); });
            if (d3.keys(text).indexOf(type) == -1) {text[type] = {}; }
            console.log(text);
            senses = definitions[type];
            sense_options = d3.map(senses, function(x) {return(x.name); }).keys()
            sense_options.push("None of the others")

            d3.select("#sense_codes").append("h3").text("Sense tags")

            d3.select("#sense_codes").selectAll("p")
                .data(senses)
                .enter()
                .append("p")
                .html(function(d) {
                    return("<b>" + d.name + "</b> ('" + d.label + "')")
                });
                
            workspace = d3.select("#concordance");

            workspace.append("h2").text("Let's disambiguate!");

            tabs = workspace.append("ul")
                .attr("class", "nav nav-tabs")
                .attr("role", "tablist");
                
            tabs.selectAll("li")
                .data(["overview", "senses", "cues"]).enter()
                .append("li")
                .attr("class", "nav-item")
                .append("a")
                    .attr("class", "nav-link")
                    .attr("id", function(d) {return(d + "-tab"); })
                    .attr("data-toggle", "tab")
                    .attr("href", function(d) {return("#" + d); })
                    .attr("role", "tab")
                    .attr("aria-controls", function(d) {return(d); })
                    .text(function(d) {return(d.toUpperCase()); });

            workspace.append("div").attr("class", "tab-content")
                .selectAll("div")
                .data(["overview", "senses", "cues"]).enter()
                .append("div")
                    .attr("class", "tab-pane")
                    .attr("id", function(d) {return(d); })
                    .attr("width", "100vp")
                    .attr("role", "tabpanel")
                    .attr("aria-labelledby", function(d) {return(d + "-tab"); });

            // OVERVIEW TAB

            d3.select("#overview")
                .classed("active", true)
                .selectAll("div")
                .data(concordances).enter()
                    .append("div").attr("class", "row no-gutters justify-content-sm-center")
                    .each(concordancer);

            // SENSE ANNOTATION TAB

            conc = d3.select("#senses").append("div").attr("class", "row mt-5")
                .append("div").attr("class", "col-sm-12").selectAll("div")
                .data(concordances).enter()
                    .append("div");

            conc.style('display', function(d) {
                    return(toClassify.indexOf(d.id) == viewing ? 'block' : 'none');
                    })
                .append("div").attr("class", "row no-gutters justify-content-sm-center").each(concordancer);

            annotations = conc.append("div").attr("class", "row")
                .attr("token_id", function(d) {return (d.id); });

            annotations.append("div").attr("class", "col-sm-6")
                .append("div").attr("class", "btn-group-toggle mt-2")
                .attr("data-toggle", "buttons")
                .selectAll("label")
                .data(sense_options)
                    .enter()
                    .append("label")
                    .attr("class", "btn shadow-sm btn-success m-1")
                    .classed("active", function(d) {
                        var here = d3.select(this.parentNode.parentNode.parentNode).attr("token_id");
                        var chosen = d3.keys(text[type]).indexOf(here) > -1 && text[type][here]['sense'] == d;
                        return (chosen ? true : null);
                    })
                    .text(function(d) {return(d); })
                    .append("input")
                    .attr("type", "radio")
                    .attr("autocomplete", "off")
                    .attr("name", "sense")
                    .attr("value", function(d) {return(d)});

            conf = annotations.append("div").attr("id", "confidence")
                .attr("class", "col-sm-6 mt-2")
                .append("div")
                .attr("class", "btn-group-toggle mt-2")
                .attr("data-toggle", "buttons")
                .attr("disabled", function() {
                    var here = d3.select(this.parentNode.parentNode).attr("token_id");
                    return (d3.keys(text[type]).indexOf(here) === -1 ? true : null);
                });

            conf.append("h4").text("How confident are you?");

            conf.append("span")
                .style('font-weight', 'bold')
                .text("Not at all ");

            conf.selectAll("label")
                .data([0, 1, 2, 3, 4, 5]).enter()
                    .append("label")
                    .attr("class", "btn shadow-sm btn-warning")
                    .text(function(d) {return(d); })
                    .append("input").attr("type", "radio")
                    .attr("autocomplete", "off").attr("name", "confidence")
                    .attr("value", function(d) {return (d); });

            conf.append("span")
                .style('font-weight', 'bold')
                .text(' Completely');

            // var doubt_reasons = ['Not enough context',
            //     'Unknown words', 'Wrong part-of-speech', 'Other'];

            // none_reasons = annotations.append("div").attr("class", "btn-group-toggle mt-2")
            //     .attr("data-toggle", "buttons")
            //     .style('display', function() {
            //         var here = d3.select(this.parentNode).attr("token_id");
            //         var chosen = d3.keys(text[type]).indexOf(here) > -1 && text[type][here]['sense'] == 'None of the others';
            //         return (chosen ? 'block' : 'none');
            //     });
            
            // none_reasons.selectAll("label")
            //     .data(doubt_reasons)
            //         .enter()
            //         .append("label")
            //         .attr("class", "btn shadow-sm btn-success m-1")
            //         // .classed("active", function(d) {
            //         //     var here = d3.select(this.parentNode.parentNode.parentNode).attr("token_id");
            //         //     var chosen = d3.keys(text[type]).indexOf(here) > -1 && text[type][here]['sense'] == d;
            //         //     return (chosen ? true : null);
            //         // })
            //         .text(function(d) {return(d); })
            //         .append("input")
            //         .attr("type", "radio")
            //         .attr("autocomplete", "off")
            //         .attr("name", "doubt")
            //         .attr("value", function(d) {return(d)});

            inputtext = conc.append("div").attr("class", "row")
                .append("div").attr("class", "col-sm-auto")
                .attr("token_id", function(d) {return (d.id); });
            // inputtext.append("br");

            inputtext.append("p").text("Any observations about this concordance?")
            inputtext.append("div").append("input")
                .attr("class", "form-control")
                .attr("disabled", function() {
                    var here = d3.select(this.parentNode.parentNode).attr("token_id");
                    return (d3.keys(text[type]).indexOf(here) == -1 ? true : null);
                })
                .attr("id", function(d) {return(d.id + "_comment"); })
                .attr("name", "comments")
                .attr("placeholder", "No comments")
                .attr("aria-label", "Comments");
            
            addButtons('senses');

            // CUES TAB

            cues = d3.select("#cues")
                .append("div").attr("class", "row")
                .append("div").attr("class", "col-sm-12")
                .selectAll("div")
                    .data(concordances).enter()
                    .append("div")
                    .style('display', function(d) {
                    return(toClassify.indexOf(d.id) == viewing ? 'block' : 'none');
                    });
            
            reminder = cues.append("div").attr("class", "row my-2")
                .append("div").attr("class", "col-sm-12")
                .append("p").attr('class', 'text-sm-center')
                .html(function(d) {
                    var this_token = text[type][d.id];
                    if (this_token == undefined) {
                        return("You haven't annotated this occurrence yet.");
                    } else {
                        return("You have assigned the sense <b>" + this_token['sense'] + "</b> to this occurrence.");
                    }
                });                    
            
            cues.append("div").attr("class", "row")
                .each(function(d) {
                    var line = d3.select(this),
                        left_context = [], right_context = [],
                        left_source = d.left.split(' '),
                        right_source = d.right.split(' ');
                    
                    for (i = 0; i < left_source.length; i++) {
                        var cw_idx = left_source.length-i-1;
                        left_context.push({'index' : 'L'+cw_idx.toString(), 'cw' : left_source[i]});
                    }

                    for (i = 0; i < right_source.length; i++) {
                        right_context.push({'index' : 'R'+(i).toString(), 'cw' : right_source[i]});
                    }

                    line.append("div").attr("class", "col-sm-auto")
                        .append("div").attr("class", "btn-group-toggle")
                        .attr("data-toggle", "buttons")
                        .attr("disabled", true)
                        .selectAll("label")
                        .data(left_context).enter()
                            .append("label").attr("class", "btn btn-cue p-0")
                            .text(function(d) {return(d.cw); })
                            .append("input").attr("type", "checkbox")
                            .attr("autocomplete", "off")
                            .attr("value", function(d) {return (d.index); });

                    line.append("div").attr("class", "col-sm-auto px-0")
                        .append("p").attr("class", "text-sm-center")
                        .style("font-weight", "bold")
                        .style("color", "#1f77b4")
                        .text(function(d) {return (d.target); });

                    line.append("div").attr("class", "col-sm-auto")
                        .append("div").attr("class", "btn-group-toggle")
                        .attr("data-toggle", "buttons")
                        .attr("disabled", true)
                        .selectAll("label")
                        .data(right_context).enter()
                            .append("label").attr("class", "btn btn-cue p-0")
                            .text(function(d) {return(d.cw); })
                            .append("input").attr("type", "checkbox")
                            .attr("autocomplete", "off")
                            .attr("value", function(d) {return (d.index); });

                });

                $("#cues").on("change", "input[type='checkbox']", function(event){
                    var analized = toClassify[viewing];
                    var answer = d3.select(this).attr('value');
                    
                    var cues_list = text[type][analized]['cues'];
                    if (cues_list.indexOf(answer) === -1) {
                        cues_list.push(answer);
                    } else { //if you are unclicking
                        cues_list.splice(cues_list.indexOf(answer), 1);
                    }

                    localStorage.setItem("annotations-" + text['user'], JSON.stringify(text));
                });

            addButtons('cues');

            function concordancer(c) {
                var line = d3.select(this);
                
                line.append("div").attr("class", "col-sm-6")
                    .append("p").attr("class", "text-sm-right")
                    .text(function(d) {return (d.left); });
                
                line.append("div").attr("class", "col-sm-1 px-0")
                    .append("p").attr("class", "text-sm-center")
                    .style("font-weight", "bold")
                    .style("color", "#1f77b4")
                    .text(function(d) {return (d.target); });

                line.append("div").attr("class", "col-sm-5")
                    .append("p").attr("class", "text-sm-left")
                    .text(function(d) {return (d.right); });
            }

            function addButtons(tab) {
                var t = tab == 'senses' ? conc : cues;

                buttons = d3.select("#" + tab).append("div")
                    .attr("class", "row justify-content-sm-center")
                    .append("div").attr("class", "col-sm-auto")
                    .append("div").attr("class", "btn-group mt-2");
                
                buttons.append("button")
                    .attr("type", "button")
                    .attr("class", "btn shadow-sm btn-secondary")
                    .text("Previous")
                    .on("click", function() {
                        viewing > 0 ? viewing -= 1 : viewing = toClassify.length-1;
                        t.style('display', function(d) {
                            return(toClassify.indexOf(d.id) == viewing ? 'block' : 'none');
                        });
                    });

                buttons.append("button")
                    .attr("type", "button")
                    .attr("class", "btn shadow-sm btn-secondary")
                    .text("Next")
                    .on("click", function() {
                        viewing < toClassify.length-1 ? viewing += 1 : viewing = 0;
                        t.style('display', function(d) {
                            return(toClassify.indexOf(d.id) == viewing ? 'block' : 'none');
                        });
                    });
            }

            // $(document).on('change', 'input[name="doubt"]', function(event) {
            //     var analized = d3.select(this.parentNode.parentNode.parentNode).attr("token_id");
            //     var answer = d3.select(this).attr('value');
            //     text[type][analized]['none_reasons'] = answer;
            // });

            $(document).on('change', 'input[name="sense"]', function(event) {
                var analized = d3.select(this.parentNode.parentNode.parentNode.parentNode).attr("token_id");
                var answer = d3.select(this).attr('value');
                // register data
                text[type][analized] = {};
                text[type][analized]['sense'] = answer;
                text[type][analized]['cues'] = [];
                
                // enable further notes
                cues.selectAll('.btn-group-toggle').attr('disabled', function(d) {
                    return(d3.keys(text[type]).indexOf(d.id) > -1 ? null : true);
                });
                conf.attr("disabled", function(d) {
                    return(d3.keys(text[type]).indexOf(d.id) > -1 ? null : true);
                });
                conc.selectAll('.form-control').attr('disabled', function(d) {
                    return(d3.keys(text[type]).indexOf(d.id) > -1 ? null : true);
                });
                // none_reasons.style('display', function() {
                //     var here = d3.select(this.parentNode).attr("token_id");
                //     var chosen = d3.keys(text[type]).indexOf(here) > -1 && text[type][here]['sense'] == 'None of the others';
                //     return (chosen ? 'block' : 'none');
                // });

                // 
                reminder.html(function(d) {
                    var this_token = text[type][d.id];
                    if (this_token == undefined) {
                        return("You haven't annotated this occurrence yet.");
                    } else {
                        return("You have assigned the sense <b>" + this_token['sense'] + "</b> to this occurrence.");
                    }
                });

                localStorage.setItem("annotations-" + text['user'], JSON.stringify(text));
                if (d3.keys(text[type]).length == concordances.length) {
                    var congratulations = ["Well done!", "Awesome!", "Great!",
                        "Proficiat!", "Indrukwekkend!"]
                    Swal.fire({
                        title: congratulations[Math.floor(Math.random()* congratulations.length)],
                        html: "You finished annotating <em>" + type + "</em>, thank you!",
                        type: "success"
                    });
                }
            });

            $(document).on('change', 'input[name="confidence"]', function(event) {
                var analized = d3.select(this.parentNode.parentNode.parentNode.parentNode).attr("token_id");
                console.log(analized);
                console.log(d3.keys(text[type]));
                console.log(d3.keys(text[type]).indexOf(analized));
                var answer = d3.select(this).property('value');
                text[type][analized]['confidence'] = answer;
                console.log(text);
            });

            $(document).on('change', 'input[name="comments"]', function(event) {
                var analized = d3.select(this.parentNode.parentNode).attr("token_id");
                var answer = d3.select(this).property('value');
                if (text[type][analized] == undefined) {
                    window.alert("You have to assign a sense first!");
                } else {
                    text[type][analized]['comments'] = answer;
                }
                console.log(text);
            });
        });
        }

        
    </script>
  </body>
</html>